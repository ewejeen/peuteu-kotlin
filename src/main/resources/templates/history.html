<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      th:with="pageTitle='프로틴 히스토리', activePage='history'"
>

<th:block layout:fragment="head">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
      /* 전체 캘린더 */
      #calendar {
          background-color: white;
          border-radius: 0.75rem; /* rounded-xl */
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); /* shadow-lg */
          padding: 1.25rem;
          border: 1px solid #e5e7eb; /* border-gray-200 */
      }

      /* 요일 헤더 */
      .fc-col-header-cell-cushion {
          font-size: 0.75rem;        /* text-xs */
          text-transform: uppercase; /* uppercase */
          letter-spacing: 0.05em;    /* tracking-wider */
          color: #9ca3af;            /* text-gray-400 */
          font-weight: 600;
      }

      /* 날짜 텍스트 */
      .fc-daygrid-day-number {
          display: inline-block;
          font-size: 0.875rem; /* text-sm */
          font-weight: 600;
          padding: 6px 8px;
          border-radius: 0.5rem;
          color: #1f2937; /* text-gray-800 */
          transition: background-color 0.2s ease;
          box-sizing: border-box;
      }

      /* 날짜 hover 효과 */
      .fc-daygrid-day:hover .fc-daygrid-day-number {
          background-color: #f3f4f6; /* bg-gray-100 */
          color: #9ca3af;
      }

      .fc-day-today {
          background-color: transparent !important; /* 전체 배경 제거 */
      }
      /* 오늘 날짜 */
      .fc-day-today .fc-daygrid-day-number {
          background-color: #dbeafe !important; /* bg-blue-100 */
          color: #2563eb !important;            /* text-blue-600 */
          font-weight: 700;
      }

      /* 목표일 */
      .goal-day .fc-daygrid-day-number  {
          background-color: #3b82f6; /* bg-blue-500 */
          color: white;
          font-weight: 700;
      }

      /* 선택된 날짜 */
      .selected-day .fc-daygrid-day-number {
          background-color: #eff6ff;
          outline: 1px solid #60a5fa; /* ring-blue-400 */
          color: #1f2937;
      }

      /* 달력 구조 다듬기 */
      .fc-theme-standard td,
      .fc-theme-standard th {
          border: none;
      }
      .fc-daygrid-event {
          background-color: transparent !important;
          font-size: 1rem;
          text-align: center;
          border: 0;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }
      .fc .fc-daygrid-day-top {
        flex-direction: column;
          text-align: center;
      }
      .fc-daygrid-day-events {
          min-height: 1em !important;
          margin-bottom: 0 !important;
          margin-top: 3px !important;
      }

      .fc .fc-day {
          padding: 6px;
      }

      .fc .fc-highlight {
          background: none;
      }

      .fc .fc-scrollgrid {
          border: 0 !important;
      }
  </style>
</th:block>

<th:block layout:fragment="content">
  <h2 class="page-title">프로틴 히스토리</h2>

  <!-- 달력 컨트롤 헤더 -->
  <div class="flex items-center justify-between mb-3 px-1">
    <!-- 이전달 -->
    <button id="prevMonthBtn"
            class="p-2 rounded-full hover:bg-gray-100 text-gray-600 hover:text-blue-600 border border-gray-300 transition"
            title="이전달">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
           viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
      </svg>
    </button>

    <!-- 📅 연도/월 -->
    <h3 id="calendarTitle" class="text-gray-800 font-semibold text-lg">
      2025년 07월
    </h3>
    <!--<button id="todayBtn" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">
      오늘
    </button>-->

    <!-- 다음달 -->
    <button id="nextMonthBtn"
            class="p-2 rounded-full hover:bg-gray-100 text-gray-600 hover:text-blue-600 border border-gray-300 transition"
            title="다음달">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
           viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
      </svg>
    </button>
  </div>


  <!-- 달력 표시 -->
  <div id="calendar" class="mb-4 rounded-lg overflow-hidden border"></div>
  <p class="text-sm text-gray-500 text-center mb-4">이 달의 목표 달성일: <span class="font-medium text-gray-700" id="successCount"></span></p>

  <!-- 히스토리 리스트 -->
  <div class="mt-4">
    <h3 class="text-blue-500 font-semibold mb-2 mt-2"><span id="historyDate"></span>의 히스토리</h3>
  </div>
  <div th:replace="~{component/protein-history :: proteinHistory}"></div>
<!--  <div th:replace="~{component/protein-register :: proteinRegister}"></div>-->
</th:block>

<script layout:fragment="script">
  function renderHistory(date) {
    const title = document.getElementById('historyDate');
    title.innerText = date;

    currentPage = 0;
    isLastPage = false;
    renderNextPage(date);
  }

  /*
    단백질 섭취일 및 성공일 조회
   */
  async function renderDatesInfo(view) {
      calendar.removeAllEvents();

      const date = view.currentStart;
      const year = date.getFullYear();
      const month = date.getMonth() + 1;

      try {
          const recordedRes = await fetch(`/api/proteins/recorded-dates?year=${year}&month=${month}`);
          if (!recordedRes.ok) throw new Error("섭취일 조회 실패");

          const successRes = await fetch(`/api/proteins/successful-dates?year=${year}&month=${month}`);
          if (!successRes.ok) throw new Error("섭취 성공일 조회 실패");

          const recordedData = await recordedRes.json();
          const successData = await successRes.json();
          const successCount = successData.data.length;

          recordedData.data.forEach(d => {
              const exists = calendar.getEvents().some(e => e.startStr === d && e.title === 'o');
              if (!exists) {
                  calendar.addEvent({title: 'o', start: `${d}`})
              }
          });

          successData.data.forEach(d => {
              const exists = calendar.getEvents().some(e => e.startStr === d && e.title === '💪');
              if (!exists) {
                  calendar.addEvent({title: '💪', start: `${d}`})
              }
          });
          document.getElementById('successCount').innerText = `${successCount}일`;
      } catch (err) {
          console.error(err);
      }
  }

  function updateCalendarTitle(view) {
      const date = view.currentStart;
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      document.getElementById('calendarTitle').innerText = `${year}년 ${month.toString().padStart(2, '0')}월`;
  }

  document.getElementById('prevMonthBtn').addEventListener('click', () => calendar.prev());
  document.getElementById('nextMonthBtn').addEventListener('click', () => calendar.next());

  let calendar;
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    let selectedCell;
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        selectable: true,
        headerToolbar: false,
        height: 'auto',
        fixedWeekCount: false,
        dateClick: function (info) {
            // 날짜 클릭 시 히스토리 조회
            renderHistory(info.dateStr);
            if (selectedCell) selectedCell.classList.remove('selected-day');
            selectedCell = info.dayEl;
            selectedCell.classList.add('selected-day');
        },
        dayCellDidMount: function (arg) {
            // console.log(arg.date.toISOString().slice(0, 10))

        },
        dayCellContent: function(arg) {
            return { domNodes: [document.createTextNode(arg.date.getDate())] };
        },
        datesSet: function (arg) {
            renderDatesInfo(arg.view);
            updateCalendarTitle(arg.view);
        },
        eventDidMount: function(info) {
            const eventDateStr = info.event.startStr;
            const cell = document.querySelector(`.fc-day[data-date="${eventDateStr}"]`);
            if (cell) {
                cell.classList.add('goal-day');
            }
        }
        // eventContent: function (arg) {
        //     return {
        //         html: `<span class="text-xs font-medium py-0.5">${arg.event.title}</span>`
        //     };
        // }

    });
    calendar.render();


    renderHistory(COMMON.getTodayDate());
  });
</script>
</html>
