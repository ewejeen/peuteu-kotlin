<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      th:with="pageTitle='í”„ë¡œí‹´ íˆìŠ¤í† ë¦¬', activePage='history'"
>

<th:block layout:fragment="head">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
      /* ì „ì²´ ìº˜ë¦°ë” */
      #calendar {
          background-color: white;
          border-radius: 0.75rem; /* rounded-xl */
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); /* shadow-lg */
          padding: 1.25rem;
          border: 1px solid #e5e7eb; /* border-gray-200 */
      }

      /* ìš”ì¼ í—¤ë” */
      .fc-col-header-cell-cushion {
          font-size: 0.75rem;        /* text-xs */
          text-transform: uppercase; /* uppercase */
          letter-spacing: 0.05em;    /* tracking-wider */
          color: #9ca3af;            /* text-gray-400 */
          font-weight: 600;
      }

      /* ë‚ ì§œ í…ìŠ¤íŠ¸ */
      .fc-daygrid-day-number {
          display: inline-block;
          font-size: 0.875rem; /* text-sm */
          font-weight: 600;
          padding: 6px 8px;
          border-radius: 0.5rem;
          color: #1f2937; /* text-gray-800 */
          transition: background-color 0.2s ease;
          box-sizing: border-box;
      }

      /* ë‚ ì§œ hover íš¨ê³¼ */
      .fc-daygrid-day:hover .fc-daygrid-day-number {
          background-color: #f3f4f6; /* bg-gray-100 */
          color: #9ca3af;
      }

      .fc-day-today {
          background-color: transparent !important; /* ì „ì²´ ë°°ê²½ ì œê±° */
      }
      /* ì˜¤ëŠ˜ ë‚ ì§œ */
      .fc-day-today .fc-daygrid-day-number {
          background-color: #dbeafe !important; /* bg-blue-100 */
          color: #2563eb !important;            /* text-blue-600 */
          font-weight: 700;
      }

      /* ëª©í‘œì¼ */
      .goal-day .fc-daygrid-day-number  {
          background-color: #3b82f6; /* bg-blue-500 */
          color: white;
          font-weight: 700;
      }

      /* ì„ íƒëœ ë‚ ì§œ */
      .selected-day .fc-daygrid-day-number {
          background-color: #eff6ff;
          outline: 1px solid #60a5fa; /* ring-blue-400 */
          color: #1f2937;
      }

      /* ë‹¬ë ¥ êµ¬ì¡° ë‹¤ë“¬ê¸° */
      .fc-theme-standard td,
      .fc-theme-standard th {
          border: none;
      }
      .fc-daygrid-event {
          background-color: transparent !important;
          font-size: 1rem;
          text-align: center;
          border: 0;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }
      .fc .fc-daygrid-day-top {
        flex-direction: column;
          text-align: center;
      }
      .fc-daygrid-day-events {
          min-height: 1em !important;
          margin-bottom: 0 !important;
          margin-top: 3px !important;
      }

      .fc .fc-day {
          padding: 6px;
      }

      .fc .fc-highlight {
          background: none;
      }

      .fc .fc-scrollgrid {
          border: 0 !important;
      }
  </style>
</th:block>

<th:block layout:fragment="content">
  <h2 class="page-title">í”„ë¡œí‹´ íˆìŠ¤í† ë¦¬</h2>

  <!-- ë‹¬ë ¥ ì»¨íŠ¸ë¡¤ í—¤ë” -->
  <div class="flex items-center justify-between mb-3 px-1">
    <!-- ì´ì „ë‹¬ -->
    <button id="prevMonthBtn"
            class="p-2 rounded-full hover:bg-gray-100 text-gray-600 hover:text-blue-600 border border-gray-300 transition"
            title="ì´ì „ë‹¬">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
           viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
      </svg>
    </button>

    <!-- ğŸ“… ì—°ë„/ì›” -->
    <h3 id="calendarTitle" class="text-gray-800 font-semibold text-lg">
      2025ë…„ 07ì›”
    </h3>
    <!--<button id="todayBtn" class="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">
      ì˜¤ëŠ˜
    </button>-->

    <!-- ë‹¤ìŒë‹¬ -->
    <button id="nextMonthBtn"
            class="p-2 rounded-full hover:bg-gray-100 text-gray-600 hover:text-blue-600 border border-gray-300 transition"
            title="ë‹¤ìŒë‹¬">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2"
           viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
      </svg>
    </button>
  </div>


  <!-- ë‹¬ë ¥ í‘œì‹œ -->
  <div id="calendar" class="mb-4 rounded-lg overflow-hidden border"></div>
  <p class="text-sm text-gray-500 text-center mb-4">ì´ ë‹¬ì˜ ëª©í‘œ ë‹¬ì„±ì¼: <span class="font-medium text-gray-700" id="successCount"></span></p>

  <!-- íˆìŠ¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ -->
  <div class="mt-4">
    <h3 class="text-blue-500 font-semibold mb-2 mt-2"><span id="historyDate"></span>ì˜ íˆìŠ¤í† ë¦¬</h3>
  </div>
  <div th:replace="~{component/protein-history :: proteinHistory}"></div>
<!--  <div th:replace="~{component/protein-register :: proteinRegister}"></div>-->
</th:block>

<script layout:fragment="script">
  function renderHistory(date) {
    const title = document.getElementById('historyDate');
    title.innerText = date;

    currentPage = 0;
    isLastPage = false;
    renderNextPage(date);
  }

  /*
    ë‹¨ë°±ì§ˆ ì„­ì·¨ì¼ ë° ì„±ê³µì¼ ì¡°íšŒ
   */
  async function renderDatesInfo(view) {
      calendar.removeAllEvents();

      const date = view.currentStart;
      const year = date.getFullYear();
      const month = date.getMonth() + 1;

      try {
          const recordedRes = await fetch(`/api/proteins/recorded-dates?year=${year}&month=${month}`);
          if (!recordedRes.ok) throw new Error("ì„­ì·¨ì¼ ì¡°íšŒ ì‹¤íŒ¨");

          const successRes = await fetch(`/api/proteins/successful-dates?year=${year}&month=${month}`);
          if (!successRes.ok) throw new Error("ì„­ì·¨ ì„±ê³µì¼ ì¡°íšŒ ì‹¤íŒ¨");

          const recordedData = await recordedRes.json();
          const successData = await successRes.json();
          const successCount = successData.data.length;

          recordedData.data.forEach(d => {
              const exists = calendar.getEvents().some(e => e.startStr === d && e.title === 'o');
              if (!exists) {
                  calendar.addEvent({title: 'o', start: `${d}`})
              }
          });

          successData.data.forEach(d => {
              const exists = calendar.getEvents().some(e => e.startStr === d && e.title === 'ğŸ’ª');
              if (!exists) {
                  calendar.addEvent({title: 'ğŸ’ª', start: `${d}`})
              }
          });
          document.getElementById('successCount').innerText = `${successCount}ì¼`;
      } catch (err) {
          console.error(err);
      }
  }

  function updateCalendarTitle(view) {
      const date = view.currentStart;
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      document.getElementById('calendarTitle').innerText = `${year}ë…„ ${month.toString().padStart(2, '0')}ì›”`;
  }

  document.getElementById('prevMonthBtn').addEventListener('click', () => calendar.prev());
  document.getElementById('nextMonthBtn').addEventListener('click', () => calendar.next());

  let calendar;
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    let selectedCell;
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        selectable: true,
        headerToolbar: false,
        height: 'auto',
        fixedWeekCount: false,
        dateClick: function (info) {
            // ë‚ ì§œ í´ë¦­ ì‹œ íˆìŠ¤í† ë¦¬ ì¡°íšŒ
            renderHistory(info.dateStr);
            if (selectedCell) selectedCell.classList.remove('selected-day');
            selectedCell = info.dayEl;
            selectedCell.classList.add('selected-day');
        },
        dayCellDidMount: function (arg) {
            // console.log(arg.date.toISOString().slice(0, 10))

        },
        dayCellContent: function(arg) {
            return { domNodes: [document.createTextNode(arg.date.getDate())] };
        },
        datesSet: function (arg) {
            renderDatesInfo(arg.view);
            updateCalendarTitle(arg.view);
        },
        eventDidMount: function(info) {
            const eventDateStr = info.event.startStr;
            const cell = document.querySelector(`.fc-day[data-date="${eventDateStr}"]`);
            if (cell) {
                cell.classList.add('goal-day');
            }
        }
        // eventContent: function (arg) {
        //     return {
        //         html: `<span class="text-xs font-medium py-0.5">${arg.event.title}</span>`
        //     };
        // }

    });
    calendar.render();


    renderHistory(COMMON.getTodayDate());
  });
</script>
</html>
