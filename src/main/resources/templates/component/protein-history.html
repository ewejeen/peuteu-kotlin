<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>

<th:block th:fragment="proteinHistory">

  <!-- ë‹¨ë°±ì§ˆ ëª©ë¡ -->
  <div class="space-y-2 protein-list" id="proteinList">
  </div>
  <div id="scrollObserverTarget" class="h-1"></div>

  <script>
      /*
        ë‹¨ë°±ì§ˆ ëª©ë¡ ì¡°íšŒ
       */
      let currentPage = 0;
      let isLastPage = false;
      let isLoading = false;

      async function renderNextPage(date) {
          if (isLoading || isLastPage) return;
          isLoading = true;

          const listEl = document.getElementById("proteinList");
          date = date ? date.replaceAll('-', '') : COMMON.getTodayDate().replaceAll('-', '');


          try {
              const res = await fetch(`/api/proteins/${date}?page=${currentPage}`);
              if (!res.ok) throw new Error("ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì‹¤íŒ¨");

              const data = await res.json();
              const content = data.data.content || [];

              if (content.length === 0 && currentPage === 0) {
                  const noContent = isHistoryPage() ?
                    `<p>ë“±ë¡ëœ ë‹¨ë°±ì§ˆì´ ì—†ì–´ìš”.</p>` :
                    `<p>ì•„ì§ ë“±ë¡ëœ ë‹¨ë°±ì§ˆì´ ì—†ì–´ìš”.</p><p>ì˜¤ëŠ˜ì˜ ë‹¨ë°±ì§ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš” ğŸ’ª</p>`;

                  listEl.innerHTML = `
                    <div class="text-center text-gray-500 text-sm py-10">
                      ${noContent}
                     </div>
                  `;

                  if(!isHistoryPage()) {
                    updateProgress(0);
                  }
                  isLastPage = true;
              } else {
                  if (currentPage === 0) {
                      listEl.innerHTML = '';
                  }

                  content.forEach((item) => {
                    const itemHTML = `
                      <div class="protein-item" data-id="${item.id}">
                        <div class="flex items-center gap-2">
                          <p class="text-sm font-medium text-gray-800 truncate">${item.name}</p>
                          <span class="text-xs text-gray-500 whitespace-nowrap">${item.intake}g</span>
                        </div>
                        <div class="flex gap-2 text-lg text-gray-700">
                          <button title="ìˆ˜ì •" class="edit-btn hover:opacity-70" onclick="toggleEditMode(${item.id}, true)">âœï¸</button>
                          <button title="ì‚­ì œ" class="delete-btn hover:opacity-70" onclick="deleteProtein(${item.id})">ğŸ—‘ï¸</button>
                        </div>
                      </div>
                    `;
                    listEl.insertAdjacentHTML("beforeend", itemHTML);
                  });

                  if(!isHistoryPage()) {
                    await renderTotalProtein();
                  }

                  if (data.data.last === true) {
                      isLastPage = true;
                  } else {
                      currentPage++;
                  }
              }
          } catch (err) {
              console.error(err);
              listEl.innerHTML = `
          <div class="text-center text-red-500 text-sm py-10">
            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.
          </div>
        `;
          } finally {
              isLoading = false;
          }
      }

      /*
        ì˜µì €ë²„ ë“±ë¡
       */
      function initIntersectionObserver() {
          const target = document.getElementById("scrollObserverTarget");

          const observer = new IntersectionObserver(
              async (entries) => {
                  const entry = entries[0];
                  if (entry.isIntersecting && !isLastPage && !isLoading) {
                      await renderNextPage();
                  }
              },
              {
                  root: null,
                  rootMargin: "0px",
                  threshold: 1.0
              }
          );

          observer.observe(target);
      }

      /*
        ë‹¨ë°±ì§ˆ ëª©ë¡ ìˆ˜ì • ëª¨ë“œ ì§„ì…
       */
      function toggleEditMode(id, isEdit) {
          const listEl = document.getElementById("proteinList");
          const itemEl = listEl.querySelector(`[data-id="${id}"]`);

          if (isEdit) {
              itemEl.classList.add('gap-2');
              const name = itemEl.querySelector("p").innerText;
              const intake = Math.round(parseInt(itemEl.querySelector("span").innerText) * 10) / 10;

              itemEl.innerHTML = `
        <input type="text" value="${name}" class="flex-1" placeholder="ì´ë¦„" id="edit-name-${id}" />
        <input type="number" value="${intake}" class="flex-1" placeholder="ì„­ì·¨ëŸ‰" id="edit-intake-${id}" step="0.1"/>
        <div class="flex gap-2 text-lg">
          <button onclick="saveEdit(${id})" title="í™•ì¸" class="hover:opacity-80">âœ…</button>
          <button onclick="toggleEditMode(${id}, false)" title="ì·¨ì†Œ" class="hover:opacity-80">âŒ</button>
        </div>
      `;
          } else {
              itemEl.classList.remove('gap-2');
              const name = document.getElementById(`edit-name-${id}`).value;
              const intake = document.getElementById(`edit-intake-${id}`).value;

              itemEl.innerHTML = `
        <div class="flex items-center gap-2">
          <p class="text-sm font-medium text-gray-800 truncate">${name}</p>
          <span class="text-xs text-gray-500 whitespace-nowrap">${intake}g</span>
        </div>
        <div class="flex gap-2 text-lg text-gray-700">
          <button title="ìˆ˜ì •" class="edit-btn hover:opacity-70" onclick="toggleEditMode(${id}, true)">âœï¸</button>
          <button title="ì‚­ì œ" class="delete-btn hover:opacity-70" onclick="deleteProtein(${id})">ğŸ—‘ï¸</button>
        </div>
      `;
          }
      }

      function isHistoryPage() {
          return window.location.href.indexOf('history') > -1;
      }

      async function renderFirstPage() {
          currentPage = 0;
          isLastPage = false;
          await renderNextPage();
      }

      window.addEventListener("DOMContentLoaded", () => {
          renderFirstPage();
          initIntersectionObserver(); // ë¬´í•œ ìŠ¤í¬ë¡¤ ê°ì§€ ì‹œì‘
      });

  </script>
</th:block>
</html>
