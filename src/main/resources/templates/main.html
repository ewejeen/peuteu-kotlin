<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      th:with="pageTitle='오늘의 프로틴', activePage='main'"
>

<th:block layout:fragment="content">
  <h2 class="page-title mb-1">오늘의 프로틴</h2>
  <p class="text-lg font-bold text-black mb-6" id="todayText">2024.10.06</p>

  <!-- 섭취량 원형 시각화 -->
  <div class="flex flex-col items-center mb-6">
    <div class="relative w-40 h-40">
      <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="45" stroke="#E5E7EB" stroke-width="10" fill="none" />
        <circle
            id="progressCircle"
            cx="50" cy="50" r="45"
            stroke="#60A5FA"
            stroke-width="10"
            fill="none"
            stroke-linecap="round"
            stroke-dasharray="282.6"
            stroke-dashoffset="282.6"
            style="transition: stroke-dashoffset 1s ease-out"
        />
      </svg>

      <div class="absolute inset-0 flex flex-col items-center justify-center">
        <p id="currentText" class="text-2xl font-bold text-blue-600">-</p>
        <p id="goalText" class="text-sm text-gray-400">/-</p>
      </div>
    </div>
    <p id="remainText" class="text-sm text-gray-500 mt-2">-</p>
  </div>

  <!-- 단백질 등록 -->
  <div class="mt-6">
    <h3 class="text-blue-500 font-semibold mb-2">프로틴 등록</h3>
    <form id="proteinForm" class="protein-submit-form">
      <div class="flex items-end gap-2">
        <div class="flex-1">
          <label for="name" class="label-submit">이름</label>
          <input type="text" name="name" id="name" placeholder="예: 단백질 쉐이크" required />
        </div>
        <div class="w-24">
          <label for="amount" class="label-submit">섭취량 (g)</label>
          <input type="number" name="amount" id="amount" placeholder="30" step="0.1" required />
        </div>
        <div>
          <button type="submit" class="btn-submit hover:bg-blue-600 transition">
            등록
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- 단백질 목록 -->
  <div class="space-y-2 mt-6 protein-list" id="proteinList">
  </div>
  <div id="scrollObserverTarget" class="h-1"></div>
</th:block>

<script layout:fragment="script">
  /*
    단백질 목록 조회
   */
  let currentPage = 0;
  let isLastPage = false;
  let isLoading = false;
  async function renderNextPage() {
    if (isLoading || isLastPage) return;
    isLoading = true;

    const listEl = document.getElementById("proteinList");
    const date = document.getElementById("todayText").innerText.replaceAll('.', '');

    try {
        const res = await fetch(`/api/proteins/${date}?page=${currentPage}`);
        if (!res.ok) throw new Error("리스트 조회 실패");

        const data = await res.json();
        const content = data.data.content || [];

        if (content.length === 0 && currentPage === 0) {
          listEl.innerHTML = `
            <div class="text-center text-gray-500 text-sm py-10">
              <p>아직 등록된 단백질이 없어요.</p>
              <p>오늘의 단백질을 추가해보세요 💪</p>
            </div>
          `;
          updateProgress(0);
          isLastPage = true;
        } else {
          if(currentPage === 0) {
            listEl.innerHTML = '';
          }

          content.forEach((item) => {
            const itemHTML = `
              <div class="protein-item" data-id="${item.id}">
                <div class="flex items-center gap-2">
                  <p class="text-sm font-medium text-gray-800 truncate">${item.name}</p>
                  <span class="text-xs text-gray-500 whitespace-nowrap">${item.amount}g</span>
                </div>
                <div class="flex gap-2 text-lg text-gray-700">
                  <button title="수정" class="edit-btn hover:opacity-70" onclick="toggleEditMode(${item.id}, true)">✏️</button>
                  <button title="삭제" class="delete-btn hover:opacity-70" onclick="deleteProtein(${item.id})">🗑️</button>
                </div>
              </div>
            `;
            listEl.insertAdjacentHTML("beforeend", itemHTML);
          });

          await renderTotalProtein();

          if (data.data.last === true) {
            isLastPage = true;
          } else {
            currentPage++;
          }
        }
    } catch (err) {
        console.error(err);
        listEl.innerHTML = `
          <div class="text-center text-red-500 text-sm py-10">
            데이터를 불러오는 중 오류가 발생했어요.
          </div>
        `;
    } finally {
        isLoading = false;
    }
  }

  /*
    옵저버 등록
   */
  function initIntersectionObserver() {
    const target = document.getElementById("scrollObserverTarget");

    const observer = new IntersectionObserver(
      async (entries) => {
        const entry = entries[0];
        if (entry.isIntersecting && !isLastPage && !isLoading) {
          await renderNextPage();
        }
      },
      {
        root: null,
        rootMargin: "0px",
        threshold: 1.0
      }
    );

    observer.observe(target);
  }

  /*
    단백질 총섭취량 조회
   */
  async function renderTotalProtein() {
    const date = document.getElementById("todayText").innerText.replaceAll('.', '');

      try {
        const res = await fetch(`/api/proteins/total/${date}`);
        if (!res.ok) throw new Error("섭취량 조회 실패");

        const data = await res.json();
        const total = data.data || 0;
        updateProgress(total);
      } catch (err) {
        console.error(err);
      }
  }

  /*
    단백질 달성률 링 업데이트
   */
  function updateProgress(currentValue) {
    const goal = 120; // TODO
    const percent = Math.min((currentValue / goal) * 100, 100);
    const circleLength = 2 * Math.PI * 45;
    const offset = circleLength * (1 - percent / 100);

    const circle = document.getElementById("progressCircle");
    const currentTextEl = document.getElementById("currentText");
    const remainTextEl = document.getElementById("remainText");

    if (circle) {
        circle.style.strokeDashoffset = offset;

        if (currentValue >= goal) {
            circle.setAttribute("stroke", "#22C55E"); // 초록색 (ex. Tailwind: green-500)
        } else {
            circle.setAttribute("stroke", "#60A5FA"); // 파란색 (blue-400)
        }
    }

    currentTextEl.innerText = `${currentValue}g`;

    if (currentValue >= goal) {
      currentTextEl.classList.remove("text-blue-600");
      currentTextEl.classList.add("text-green-500", "text-3xl", "animate-pulse");

      remainTextEl.innerText = '🎉 오늘의 프로틴을 모두 채웠어요!';
      remainTextEl.classList.remove("text-gray-500", "mt-2");
      remainTextEl.classList.add("text-green-600", "text-lg", "font-semibold", "animate-bounce", "mt-3");
    } else {
      currentTextEl.classList.remove("text-green-500", "text-3xl", "animate-pulse");
      currentTextEl.classList.add("text-blue-600");

      let remain = Math.round((goal - currentValue) * 10) / 10;
      remainTextEl.innerText = `${remain}g 남았어요!`;
      remainTextEl.classList.remove("text-green-600", "text-lg", "font-semibold", "animate-bounce", "mt-3");
      remainTextEl.classList.add("text-gray-500", "mt-2");
    }
  }

  /*
    단백질 목록 수정 모드 진입
   */
  function toggleEditMode(id, isEdit) {
    const listEl = document.getElementById("proteinList");
    const itemEl = listEl.querySelector(`[data-id="${id}"]`);

    if(isEdit) {
      itemEl.classList.add('gap-2');
      const name = itemEl.querySelector("p").innerText;
      const amount = Math.round(parseInt(itemEl.querySelector("span").innerText) * 10) / 10;

      itemEl.innerHTML = `
        <input type="text" value="${name}" class="flex-1" placeholder="이름" id="edit-name-${id}" />
        <input type="number" value="${amount}" class="flex-1" placeholder="섭취량" id="edit-amount-${id}" step="0.1"/>
        <div class="flex gap-2 text-lg">
          <button onclick="saveEdit(${id})" title="확인" class="hover:opacity-80">✅</button>
          <button onclick="toggleEditMode(${id}, false)" title="취소" class="hover:opacity-80">❌</button>
        </div>
      `;
    } else {
      itemEl.classList.remove('gap-2');
      const name = document.getElementById(`edit-name-${id}`).value;
      const amount = document.getElementById(`edit-amount-${id}`).value;

      itemEl.innerHTML = `
        <div class="flex items-center gap-2">
          <p class="text-sm font-medium text-gray-800 truncate">${name}</p>
          <span class="text-xs text-gray-500 whitespace-nowrap">${amount}g</span>
        </div>
        <div class="flex gap-2 text-lg text-gray-700">
          <button title="수정" class="edit-btn hover:opacity-70" onclick="toggleEditMode(${id}, true)">✏️</button>
          <button title="삭제" class="delete-btn hover:opacity-70" onclick="deleteProtein(${id})">🗑️</button>
        </div>
      `;
    }
  }

  /*
    단백질 수정
   */
  async function saveEdit(id) {
    const name = document.getElementById(`edit-name-${id}`).value.trim();
    const amount = Math.round(document.getElementById(`edit-amount-${id}`).value.trim() * 10) / 10;

    if (!name || isNaN(amount) || amount <= 0) {
      alert("이름과 유효한 섭취량을 입력해주세요.");
      return;
    }

    try {
      const res = await fetch(`/api/proteins/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, amount })
      });

      if (!res.ok) throw new Error("수정 실패");

      const listEl = document.getElementById("proteinList");
      const itemEl = listEl.querySelector(`[data-id="${id}"]`);
      itemEl.classList.remove('gap-2');

      itemEl.innerHTML = `
        <div class="flex items-center gap-2">
          <p class="text-sm font-medium text-gray-800 truncate">${name}</p>
          <span class="text-xs text-gray-500 whitespace-nowrap">${amount}g</span>
        </div>
        <div class="flex gap-2 text-lg text-gray-700">
          <button title="수정" class="edit-btn hover:opacity-70" onclick="toggleEditMode(${id}, true)">✏️</button>
          <button title="삭제" class="delete-btn hover:opacity-70" onclick="deleteProtein(${id})">🗑️</button>
        </div>
      `;
    } catch (err) {
      console.error(err);
      alert("수정 중 오류가 발생했습니다.");
    }
  }

  /*
    단백질 신규 등록
   */
  async function saveProtein(e) {
    e.preventDefault(); // form 기본 제출 막기

    const nameInput = document.getElementById("name");
    const amountInput = document.getElementById("amount");
    const name = nameInput.value.trim();
    const amount = Math.round(amountInput.value.trim() * 10) / 10;

    if (!name || isNaN(amount) || amount <= 0) {
      alert("이름과 유효한 섭취량을 입력해주세요.");
      return;
    }

    try {
      const res = await fetch("/api/proteins", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, amount })
      });

      if (!res.ok) throw new Error("등록 실패");

      currentPage = 0;
      isLastPage = false;
      await renderNextPage();
      nameInput.value = "";
      amountInput.value = "";
    } catch (err) {
      console.error(err);
      alert("서버 오류로 등록에 실패했습니다.");
    }
  }

  /*
    단백질 삭제
   */
  async function deleteProtein(id) {
    if (!confirm("정말 삭제하시겠습니까?")) return;

    try {
      const res = await fetch(`/api/proteins/${id}`, {
        method: "DELETE"
      });

      if (!res.ok) throw new Error("삭제 실패");

      currentPage = 0;
      isLastPage = false;
      await renderNextPage();
    } catch (err) {
      console.error(err);
      alert("삭제 중 오류가 발생했습니다.");
    }
  }

  /*
    오늘 날짜 세팅
   */
  function setToday() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById("todayText").innerText = `${yyyy}.${mm}.${dd}`;
  }

  /*
    목표 텍스트 세팅
   */
  function setGoal() {
      const goal = 120;
      document.getElementById("goalText").innerText = `/${goal}g`;
  }

  document.getElementById("proteinForm").addEventListener("submit", saveProtein);
  window.addEventListener("DOMContentLoaded", () => {
    setToday();
    setGoal();
    renderNextPage();
    initIntersectionObserver(); // 무한 스크롤 감지 시작
  });

</script>
</html>
