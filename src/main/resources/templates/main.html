<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      th:with="pageTitle='ì˜¤ëŠ˜ì˜ í”„ë¡œí‹´', activePage='main'"
>

<th:block layout:fragment="content">
  <h2 class="page-title mb-1">ì˜¤ëŠ˜ì˜ í”„ë¡œí‹´</h2>
  <p class="text-lg font-bold text-black mb-6" id="todayText">2024.10.06</p>

  <!-- ì„­ì·¨ëŸ‰ ì›í˜• ì‹œê°í™” -->
  <div class="flex flex-col items-center mb-6">
    <div class="relative w-40 h-40">
      <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="45" stroke="#E5E7EB" stroke-width="10" fill="none" />
        <circle
            id="progressCircle"
            cx="50" cy="50" r="45"
            stroke="#60A5FA"
            stroke-width="10"
            fill="none"
            stroke-linecap="round"
            stroke-dasharray="282.6"
            stroke-dashoffset="282.6"
            style="transition: stroke-dashoffset 1s ease-out"
        />
      </svg>

      <div class="absolute inset-0 flex flex-col items-center justify-center">
        <p id="currentText" class="text-2xl font-bold text-blue-600">-</p>
        <p id="goalText" class="text-sm text-gray-400">/-</p>
      </div>
    </div>
    <p id="remainText" class="text-sm text-gray-500 mt-2">-</p>
  </div>

  <!-- ë‹¨ë°±ì§ˆ ë“±ë¡ -->
  <div class="mt-6">
    <h3 class="text-blue-500 font-semibold mb-2">í”„ë¡œí‹´ ë“±ë¡</h3>
    <form id="proteinForm" class="protein-submit-form">
      <div class="flex items-end gap-2">
        <div class="flex-1">
          <label for="name" class="label-submit">ì´ë¦„</label>
          <input type="text" name="name" id="name" placeholder="ì˜ˆ: ë‹¨ë°±ì§ˆ ì‰ì´í¬" required />
        </div>
        <div class="w-24">
          <label for="amount" class="label-submit">ì„­ì·¨ëŸ‰ (g)</label>
          <input type="number" name="amount" id="amount" placeholder="30" step="0.1" required />
        </div>
        <div>
          <button type="submit" class="btn-submit hover:bg-blue-600 transition">
            ë“±ë¡
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- ë‹¨ë°±ì§ˆ ëª©ë¡ -->
  <div class="space-y-2 mt-6 protein-list" id="proteinList">
  </div>
  <div id="scrollObserverTarget" class="h-1"></div>
</th:block>

<script layout:fragment="script">
  /*
    ë‹¨ë°±ì§ˆ ëª©ë¡ ì¡°íšŒ
   */
  let currentPage = 0;
  let isLastPage = false;
  let isLoading = false;
  async function renderNextPage() {
    if (isLoading || isLastPage) return;
    isLoading = true;

    const listEl = document.getElementById("proteinList");
    const date = document.getElementById("todayText").innerText.replaceAll('.', '');

    try {
        const res = await fetch(`/api/proteins/${date}?page=${currentPage}`);
        if (!res.ok) throw new Error("ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ì‹¤íŒ¨");

        const data = await res.json();
        const content = data.data.content || [];

        if (content.length === 0 && currentPage === 0) {
          listEl.innerHTML = `
            <div class="text-center text-gray-500 text-sm py-10">
              <p>ì•„ì§ ë“±ë¡ëœ ë‹¨ë°±ì§ˆì´ ì—†ì–´ìš”.</p>
              <p>ì˜¤ëŠ˜ì˜ ë‹¨ë°±ì§ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš” ğŸ’ª</p>
            </div>
          `;
          updateProgress(0);
          isLastPage = true;
        } else {
          if(currentPage === 0) {
            listEl.innerHTML = '';
          }

          content.forEach((item) => {
            const itemHTML = `
              <div class="protein-item" data-id="${item.id}">
                <div class="flex items-center gap-2">
                  <p class="text-sm font-medium text-gray-800 truncate">${item.name}</p>
                  <span class="text-xs text-gray-500 whitespace-nowrap">${item.amount}g</span>
                </div>
                <div class="flex gap-2 text-lg text-gray-700">
                  <button title="ìˆ˜ì •" class="edit-btn hover:opacity-70" onclick="toggleEditMode(${item.id}, true)">âœï¸</button>
                  <button title="ì‚­ì œ" class="delete-btn hover:opacity-70" onclick="deleteProtein(${item.id})">ğŸ—‘ï¸</button>
                </div>
              </div>
            `;
            listEl.insertAdjacentHTML("beforeend", itemHTML);
          });

          await renderTotalProtein();

          if (data.data.last === true) {
            isLastPage = true;
          } else {
            currentPage++;
          }
        }
    } catch (err) {
        console.error(err);
        listEl.innerHTML = `
          <div class="text-center text-red-500 text-sm py-10">
            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.
          </div>
        `;
    } finally {
        isLoading = false;
    }
  }

  /*
    ì˜µì €ë²„ ë“±ë¡
   */
  function initIntersectionObserver() {
    const target = document.getElementById("scrollObserverTarget");

    const observer = new IntersectionObserver(
      async (entries) => {
        const entry = entries[0];
        if (entry.isIntersecting && !isLastPage && !isLoading) {
          await renderNextPage();
        }
      },
      {
        root: null,
        rootMargin: "0px",
        threshold: 1.0
      }
    );

    observer.observe(target);
  }

  /*
    ë‹¨ë°±ì§ˆ ì´ì„­ì·¨ëŸ‰ ì¡°íšŒ
   */
  async function renderTotalProtein() {
    const date = document.getElementById("todayText").innerText.replaceAll('.', '');

      try {
        const res = await fetch(`/api/proteins/total/${date}`);
        if (!res.ok) throw new Error("ì„­ì·¨ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨");

        const data = await res.json();
        const total = data.data || 0;
        updateProgress(total);
      } catch (err) {
        console.error(err);
      }
  }

  /*
    ë‹¨ë°±ì§ˆ ë‹¬ì„±ë¥  ë§ ì—…ë°ì´íŠ¸
   */
  function updateProgress(currentValue) {
    const goal = 120; // TODO
    const percent = Math.min((currentValue / goal) * 100, 100);
    const circleLength = 2 * Math.PI * 45;
    const offset = circleLength * (1 - percent / 100);

    const circle = document.getElementById("progressCircle");
    const currentTextEl = document.getElementById("currentText");
    const remainTextEl = document.getElementById("remainText");

    if (circle) {
        circle.style.strokeDashoffset = offset;

        if (currentValue >= goal) {
            circle.setAttribute("stroke", "#22C55E"); // ì´ˆë¡ìƒ‰ (ex. Tailwind: green-500)
        } else {
            circle.setAttribute("stroke", "#60A5FA"); // íŒŒë€ìƒ‰ (blue-400)
        }
    }

    currentTextEl.innerText = `${currentValue}g`;

    if (currentValue >= goal) {
      currentTextEl.classList.remove("text-blue-600");
      currentTextEl.classList.add("text-green-500", "text-3xl", "animate-pulse");

      remainTextEl.innerText = 'ğŸ‰ ì˜¤ëŠ˜ì˜ í”„ë¡œí‹´ì„ ëª¨ë‘ ì±„ì› ì–´ìš”!';
      remainTextEl.classList.remove("text-gray-500", "mt-2");
      remainTextEl.classList.add("text-green-600", "text-lg", "font-semibold", "animate-bounce", "mt-3");
    } else {
      currentTextEl.classList.remove("text-green-500", "text-3xl", "animate-pulse");
      currentTextEl.classList.add("text-blue-600");

      let remain = Math.round((goal - currentValue) * 10) / 10;
      remainTextEl.innerText = `${remain}g ë‚¨ì•˜ì–´ìš”!`;
      remainTextEl.classList.remove("text-green-600", "text-lg", "font-semibold", "animate-bounce", "mt-3");
      remainTextEl.classList.add("text-gray-500", "mt-2");
    }
  }

  /*
    ë‹¨ë°±ì§ˆ ëª©ë¡ ìˆ˜ì • ëª¨ë“œ ì§„ì…
   */
  function toggleEditMode(id, isEdit) {
    const listEl = document.getElementById("proteinList");
    const itemEl = listEl.querySelector(`[data-id="${id}"]`);

    if(isEdit) {
      itemEl.classList.add('gap-2');
      const name = itemEl.querySelector("p").innerText;
      const amount = Math.round(parseInt(itemEl.querySelector("span").innerText) * 10) / 10;

      itemEl.innerHTML = `
        <input type="text" value="${name}" class="flex-1" placeholder="ì´ë¦„" id="edit-name-${id}" />
        <input type="number" value="${amount}" class="flex-1" placeholder="ì„­ì·¨ëŸ‰" id="edit-amount-${id}" step="0.1"/>
        <div class="flex gap-2 text-lg">
          <button onclick="saveEdit(${id})" title="í™•ì¸" class="hover:opacity-80">âœ…</button>
          <button onclick="toggleEditMode(${id}, false)" title="ì·¨ì†Œ" class="hover:opacity-80">âŒ</button>
        </div>
      `;
    } else {
      itemEl.classList.remove('gap-2');
      const name = document.getElementById(`edit-name-${id}`).value;
      const amount = document.getElementById(`edit-amount-${id}`).value;

      itemEl.innerHTML = `
        <div class="flex items-center gap-2">
          <p class="text-sm font-medium text-gray-800 truncate">${name}</p>
          <span class="text-xs text-gray-500 whitespace-nowrap">${amount}g</span>
        </div>
        <div class="flex gap-2 text-lg text-gray-700">
          <button title="ìˆ˜ì •" class="edit-btn hover:opacity-70" onclick="toggleEditMode(${id}, true)">âœï¸</button>
          <button title="ì‚­ì œ" class="delete-btn hover:opacity-70" onclick="deleteProtein(${id})">ğŸ—‘ï¸</button>
        </div>
      `;
    }
  }

  /*
    ë‹¨ë°±ì§ˆ ìˆ˜ì •
   */
  async function saveEdit(id) {
    const name = document.getElementById(`edit-name-${id}`).value.trim();
    const amount = Math.round(document.getElementById(`edit-amount-${id}`).value.trim() * 10) / 10;

    if (!name || isNaN(amount) || amount <= 0) {
      alert("ì´ë¦„ê³¼ ìœ íš¨í•œ ì„­ì·¨ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    try {
      const res = await fetch(`/api/proteins/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, amount })
      });

      if (!res.ok) throw new Error("ìˆ˜ì • ì‹¤íŒ¨");

      const listEl = document.getElementById("proteinList");
      const itemEl = listEl.querySelector(`[data-id="${id}"]`);
      itemEl.classList.remove('gap-2');

      itemEl.innerHTML = `
        <div class="flex items-center gap-2">
          <p class="text-sm font-medium text-gray-800 truncate">${name}</p>
          <span class="text-xs text-gray-500 whitespace-nowrap">${amount}g</span>
        </div>
        <div class="flex gap-2 text-lg text-gray-700">
          <button title="ìˆ˜ì •" class="edit-btn hover:opacity-70" onclick="toggleEditMode(${id}, true)">âœï¸</button>
          <button title="ì‚­ì œ" class="delete-btn hover:opacity-70" onclick="deleteProtein(${id})">ğŸ—‘ï¸</button>
        </div>
      `;
    } catch (err) {
      console.error(err);
      alert("ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /*
    ë‹¨ë°±ì§ˆ ì‹ ê·œ ë“±ë¡
   */
  async function saveProtein(e) {
    e.preventDefault(); // form ê¸°ë³¸ ì œì¶œ ë§‰ê¸°

    const nameInput = document.getElementById("name");
    const amountInput = document.getElementById("amount");
    const name = nameInput.value.trim();
    const amount = Math.round(amountInput.value.trim() * 10) / 10;

    if (!name || isNaN(amount) || amount <= 0) {
      alert("ì´ë¦„ê³¼ ìœ íš¨í•œ ì„­ì·¨ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    try {
      const res = await fetch("/api/proteins", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, amount })
      });

      if (!res.ok) throw new Error("ë“±ë¡ ì‹¤íŒ¨");

      currentPage = 0;
      isLastPage = false;
      await renderNextPage();
      nameInput.value = "";
      amountInput.value = "";
    } catch (err) {
      console.error(err);
      alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /*
    ë‹¨ë°±ì§ˆ ì‚­ì œ
   */
  async function deleteProtein(id) {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
      const res = await fetch(`/api/proteins/${id}`, {
        method: "DELETE"
      });

      if (!res.ok) throw new Error("ì‚­ì œ ì‹¤íŒ¨");

      currentPage = 0;
      isLastPage = false;
      await renderNextPage();
    } catch (err) {
      console.error(err);
      alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }

  /*
    ì˜¤ëŠ˜ ë‚ ì§œ ì„¸íŒ…
   */
  function setToday() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById("todayText").innerText = `${yyyy}.${mm}.${dd}`;
  }

  /*
    ëª©í‘œ í…ìŠ¤íŠ¸ ì„¸íŒ…
   */
  function setGoal() {
      const goal = 120;
      document.getElementById("goalText").innerText = `/${goal}g`;
  }

  document.getElementById("proteinForm").addEventListener("submit", saveProtein);
  window.addEventListener("DOMContentLoaded", () => {
    setToday();
    setGoal();
    renderNextPage();
    initIntersectionObserver(); // ë¬´í•œ ìŠ¤í¬ë¡¤ ê°ì§€ ì‹œì‘
  });

</script>
</html>
